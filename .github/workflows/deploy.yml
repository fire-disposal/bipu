name: Build & Deploy Backend Stack

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deploy'

env:
  IMAGE_BASE: ghcr.io/${{ github.repository }}/bipupu-backend
  NGINX_IMAGE_BASE: ghcr.io/${{ github.repository }}/bipupu-nginx

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute Tag Once
        id: ver
        run: |
          set -euo pipefail
          TAG_SHORT="${GITHUB_SHA:0:8}"
          TAG_FINAL="${TAG_SHORT:-latest}"
          echo "BACKEND_IMAGE=${{ env.IMAGE_BASE }}:$TAG_FINAL" >> "$GITHUB_OUTPUT"
          echo "NGINX_IMAGE=${{ env.NGINX_IMAGE_BASE }}:$TAG_FINAL" >> "$GITHUB_OUTPUT"
          echo "TAG=$TAG_FINAL" >> "$GITHUB_OUTPUT"

      - name: Build & Push Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ steps.ver.outputs.BACKEND_IMAGE }}
            ${{ env.IMAGE_BASE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & Push Nginx Image
        uses: docker/build-push-action@v5
        with:
          context: ./docker/nginx
          file: ./docker/nginx/Dockerfile
          push: true
          tags: |
            ${{ steps.ver.outputs.NGINX_IMAGE }}
            ${{ env.NGINX_IMAGE_BASE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Setup SSH Key
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo -e "Host *\n  StrictHostKeyChecking no\n  UserKnownHostsFile /dev/null" >> ~/.ssh/config

      - name: Render & Upload Stack Files
        run: |
          set -euo pipefail
          
          sed "s|bipupu-backend:local|${{ steps.ver.outputs.BACKEND_IMAGE }}|g; s|bipupu-nginx:local|${{ steps.ver.outputs.NGINX_IMAGE }}|g" \
            docker/docker-compose.yml > docker/docker-compose.rendered.yml

          cat > docker/.env <<EOF
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}
          COMPOSE_BAKE=true
          EOF

          echo "ðŸ“¤ Uploading files to server..."
          scp -i ~/.ssh/id_rsa docker/docker-compose.rendered.yml \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/docker-compose.yml
          scp -i ~/.ssh/id_rsa docker/.env \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/.env

      - name: Deploy Stack via SSH
        run: |
          ssh -i ~/.ssh/id_rsa -T ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -euo pipefail

            echo "ðŸ”‘ Dockerç™»å½•..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            echo "ðŸ“¥ æ‹‰å–é•œåƒ..."
            docker compose -f ~/docker-compose.yml --env-file ~/.env pull
            
            echo "ðŸ” éªŒè¯é•œåƒ:"
            docker images | grep bipupu || echo "âš ï¸ æœªæ‰¾åˆ°bipupué•œåƒ"

            echo "ðŸš€ åœæ­¢æ—§å®¹å™¨..."
            docker compose -f ~/docker-compose.yml --env-file ~/.env down --remove-orphans
            
            echo "ðŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            docker compose -f ~/docker-compose.yml --env-file ~/.env up -d
            
            echo "â³ ç­‰å¾…å®¹å™¨åˆå§‹åŒ–..."
            sleep 10
            
            echo "ðŸ“‹ æ£€æŸ¥å®¹å™¨çŠ¶æ€:"
            docker ps -a | grep bipupu || true

            echo "ðŸ“‹ æ£€æŸ¥ç«¯å£ç›‘å¬:"
            ss -tlnp | grep :8000 || true

            echo "ðŸ” å¼€å§‹å¥åº·æ£€æŸ¥ (Max 20 attempts, 5s interval)..."
            health_check_passed=false
            for i in {1..20}; do
              if docker exec bipupu-backend uv run python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                health_check_passed=true
                break
              fi
              echo "â³ Health check $i/20 failed, waiting 5 seconds..."
              if [ $i -eq 5 ] || [ $i -eq 10 ] || [ $i -eq 15 ]; then
                echo "--- è¯Šæ–­ä¿¡æ¯ ---"
                docker ps -a | grep bipupu
                docker compose logs backend --tail 50
                echo "----------------"
              fi
              sleep 5
            done

            if [ "$health_check_passed" != "true" ]; then
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œæ”¶é›†æœ€ç»ˆè¯Šæ–­ä¿¡æ¯:"
              docker ps -a
              docker compose logs backend --tail 50
              docker compose logs db --tail 20
              docker compose logs redis --tail 20
              exit 1
            fi
            
            echo "ðŸ“¦ è®°å½•æˆåŠŸéƒ¨ç½²çš„ç‰ˆæœ¬..."
            echo "${{ steps.ver.outputs.TAG }}" > ~/last_successful_version.txt
            echo "âœ… bipupu Backend Deploy OK"
            echo "âœ… Deploy OK"
          EOF
      - name: âœ… Finish Deployment
        run: "echo \"ðŸš€ Deploy finished â€” Backend: ${{ steps.ver.outputs.BACKEND_IMAGE }} â€” Nginx: ${{ steps.ver.outputs.NGINX_IMAGE }}\""