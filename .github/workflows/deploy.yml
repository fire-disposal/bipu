name: fastapiåŽç«¯éƒ¨ç½²

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "éƒ¨ç½²åŽŸå› "
        required: false
        default: "æ‰‹åŠ¨è§¦å‘éƒ¨ç½²"

env:
  IMAGE_BASE: ghcr.io/${{ github.repository }}/bipupu-backend

jobs:
  deploy:
    name: ðŸ—ï¸ ç¼–è¯‘å¹¶éƒ¨ç½²
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ èŽ·å–æºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” ç™»å½• GitHub é•œåƒä»“åº“
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
        id: ver
        run: |
          TAG_FINAL="${GITHUB_SHA:0:8}"
          echo "BACKEND_IMAGE=${{ env.IMAGE_BASE }}:$TAG_FINAL" >> "$GITHUB_OUTPUT"
          echo "TAG=$TAG_FINAL" >> "$GITHUB_OUTPUT"

      - name: ðŸ“¦ æž„å»ºå¹¶æŽ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ steps.ver.outputs.BACKEND_IMAGE }}
            ${{ env.IMAGE_BASE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ”‘ é…ç½® SSH å¯†é’¥ (ç›´æŽ¥æ–‡ä»¶æ¨¡å¼)
        run: |
          mkdir -p ~/.ssh
          # ä¸ºäº†æœ€å¤§åŒ–å…¼å®¹æ€§ï¼ˆè§£å†³ docker context è¯»å– ssh-agent å¤±è´¥çš„é—®é¢˜ï¼‰ï¼Œ
          # ä¹Ÿå°±æ˜¯æ¢å¤åˆ°å°†ç§é’¥å†™å…¥ä¸´æ—¶æ–‡ä»¶çš„ä¼ ç»Ÿæ–¹å¼ã€‚Runner ç»“æŸåŽä¼šè‡ªåŠ¨æ¸…ç†ã€‚
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # æ‰«æå¹¶ä¿¡ä»»æœåŠ¡å™¨æŒ‡çº¹
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

          # é…ç½® SSH Config ä»¥ç¡®ä¿ Docker å‘½ä»¤ä¹Ÿèƒ½ä½¿ç”¨æ­£ç¡®çš„ SSH å‚æ•°
          echo "Host remote-server" >> ~/.ssh/config
          echo "  HostName ${{ secrets.SERVER_HOST }}" >> ~/.ssh/config
          echo "  User ${{ secrets.SERVER_USER }}" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          
          # æµ‹è¯•è¿žæŽ¥ï¼ˆåŽ»æŽ‰ || true ä»¥ä¾¿å‡ºé”™æ—¶ç«‹å³åœæ­¢ï¼‰
          echo "Testing SSH Connection..."
          ssh remote-server "echo 'âœ… SSH Connection OK'"

      - name: ðŸŒ æ¿€æ´»è¿œç¨‹ Docker ä¸Šä¸‹æ–‡
        run: |
          # ä½¿ç”¨ config ä¸­å®šä¹‰çš„ Host åˆ«å
          docker context create remote-context --docker "host=ssh://remote-server"
          docker context use remote-context

      - name: ðŸš€ æ‰§è¡Œè¿œç¨‹æ»šåŠ¨éƒ¨ç½²
        env:
          # æ•æ„Ÿä¿¡æ¯é€šè¿‡çŽ¯å¢ƒå˜é‡æ³¨å…¥å†…å­˜ï¼Œä¸ç”Ÿæˆç‰©ç†æ–‡ä»¶
          BACKEND_IMAGE: ${{ steps.ver.outputs.BACKEND_IMAGE }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
        run: |
          echo "ðŸ”‘ åˆ·æ–°è¿œç¨‹ç™»å½•çŠ¶æ€..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          echo "ðŸ“¡ æ‹‰å–æ–°é•œåƒå¹¶å¯åŠ¨æœåŠ¡..."
          docker compose \
            -f docker/docker-compose.yml \
            -f docker/docker-compose.prod.yml \
            up -d --remove-orphans

      - name: ðŸ©º è¿è¡Œè¿œç¨‹å¥åº·æ£€æŸ¥
        run: |
          echo "ðŸ” æ­£åœ¨ç¡®è®¤æœåŠ¡å¯ç”¨æ€§..."
          success=false
          for i in {1..10}; do
            # ç›´æŽ¥åœ¨è¿œç¨‹å®¹å™¨ä¸­é€šè¿‡ uv è¿è¡Œå¥åº·æ£€æŸ¥
            if docker exec bipupu-backend uv run python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')" 2>/dev/null; then
              echo "âœ… æœåŠ¡å·²å°±ç»ªï¼"
              success=true
              break
            fi
            echo "â³ æ£€æŸ¥ä¸­ ($i/10)..."
            sleep 6
          done

          if [ "$success" != "true" ]; then
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¾“å‡ºå¼‚å¸¸æ—¥å¿—ï¼š"
            docker compose -f docker/docker-compose.yml -f docker/docker-compose.prod.yml logs --tail 50
            exit 1
          fi

      - name: ðŸ§¹ æ¸…ç†æ—§é•œåƒ
        run: |
          # è‡ªåŠ¨åˆ é™¤æœåŠ¡å™¨ä¸Šè¶…è¿‡ 24 å°æ—¶çš„æ— ç”¨é•œåƒï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´
          docker image prune -f --filter "until=24h"

      - name: ðŸŽ‰ éƒ¨ç½²å®Œæˆé€šçŸ¥
        run: |
          echo "ðŸš€ æˆåŠŸéƒ¨ç½²ç‰ˆæœ¬: ${{ steps.ver.outputs.TAG }}"
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo ${{ steps.ver.outputs.TAG }} > ~/last_version.txt"