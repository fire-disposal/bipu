name: flutterç”¨æˆ·ç«¯Apk Release

on:
  push:
    tags:
      - "v*"
      - "[0-9]+.[0-9]+.[0-9]+*"
  workflow_dispatch:
    inputs:
      version_name:
        description: "Manual Version Name (e.g., v1.0.0)"
        required: false
        default: "manual-build"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # ========= 0ï¸âƒ£ Checkout =========
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å¿…é¡»è®¾ç½®ä¸º 0 æ‰èƒ½è·å–å®Œæ•´çš„ git log

      # ========= 1ï¸âƒ£ å‡†å¤‡æ¨¡å‹ç›®å½• =========
      - name: Prepare model directories
        run: |
          mkdir -p mobile/assets/models/asr
          mkdir -p mobile/assets/models/tts

      # ========= 2ï¸âƒ£ ä¸‹è½½æ¨¡å‹ï¼ˆå›ºå®šä» v1.0.0 ä¸‹è½½ï¼‰ =========
      - name: Download ASR / TTS models
        run: |
          FIXED_MODEL_VERSION="v1.0.0"
          curl -L -o asr.7z \
            "https://github.com/${{ github.repository }}/releases/download/${FIXED_MODEL_VERSION}/asr.7z"
          curl -L -o tts.7z \
            "https://github.com/${{ github.repository }}/releases/download/${FIXED_MODEL_VERSION}/tts.7z"

      # ========= 3ï¸âƒ£ SHA256 æ ¡éªŒ =========
      - name: Verify model checksums
        run: |
          echo "be74a6387e96f79463fc8d415be0d00f542693add08c3458c58f583583a56351  asr.7z" | sha256sum -c -
          echo "ed9c6ba1c7b75e8eafde0df3a886c684eba67b3dad448e2f937d74eea611b863  tts.7z" | sha256sum -c -

      # ========= 4ï¸âƒ£ è§£å‹æ¨¡å‹ =========
      - name: Extract models
        run: |
          sudo apt-get update && sudo apt-get install -y p7zip-full
          7z x asr.7z -omobile/assets/models/asr -y
          7z x tts.7z -omobile/assets/models/tts -y

      # ========= 5ï¸âƒ£ ç¯å¢ƒé…ç½® & ç¼“å­˜ =========
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: "17"
          cache: gradle # è‡ªåŠ¨ç¼“å­˜ Gradle ä¾èµ–

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true # è‡ªåŠ¨ç¼“å­˜ Flutter SDK

      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('mobile/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      # ========= 6ï¸âƒ£ Flutter æ„å»º =========
      - name: Build APK
        working-directory: mobile
        env:
          # å¢åŠ  JVM å†…å­˜ä»¥åº”å¯¹å¤§æ¨¡å‹æ‰“åŒ…ï¼Œé˜²æ­¢ 11 åˆ†é’Ÿåçš„ OOM
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=512m"
        run: |
          flutter pub get
          # ä½¿ç”¨ --no-pub ç¡®ä¿ä¸å†è¿›è¡Œå†—ä½™æ£€æŸ¥ï¼ŒåŠ é€Ÿæ„å»º
          flutter build apk --split-per-abi --no-pub

      # ========= 7ï¸âƒ£ APK é‡å‘½å & äº§ç‰©å‡†å¤‡ =========
      - name: Prepare Artifacts
        id: prepare
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version_name }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          APK_DIR="mobile/build/app/outputs/flutter-apk"

          # é‡å‘½åå¹¶ä¿å­˜è·¯å¾„åˆ° OUTPUT
          mv "$APK_DIR/app-armeabi-v7a-release.apk" "$APK_DIR/mobile_${VERSION}_armeabi-v7a.apk"
          mv "$APK_DIR/app-arm64-v8a-release.apk" "$APK_DIR/mobile_${VERSION}_arm64-v8a.apk"
          mv "$APK_DIR/app-x86_64-release.apk" "$APK_DIR/mobile_${VERSION}_x86_64.apk"

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "arm32_apk=$APK_DIR/mobile_${VERSION}_armeabi-v7a.apk" >> "$GITHUB_OUTPUT"
          echo "arm64_apk=$APK_DIR/mobile_${VERSION}_arm64-v8a.apk" >> "$GITHUB_OUTPUT"
          echo "x64_apk=$APK_DIR/mobile_${VERSION}_x86_64.apk" >> "$GITHUB_OUTPUT"

      # ========= 8ï¸âƒ£ åŠ¨æ€ç”Ÿæˆ Release Body =========
      - name: Generate release body
        shell: bash
        run: |
          VERSION="${{ steps.prepare.outputs.version }}"
          RECENT_COMMITS=$(git log -5 --pretty=format:"- %s (%h)")

          cat <<EOF > release.md
          ## ğŸš€ Release ${VERSION}

          ğŸ“¦ **æ„å»ºè¯´æ˜ï¼š**
          - æœ¬ Release ç”± GitHub Actions è‡ªåŠ¨æ„å»º
          - å¯¹åº”ä»£ç çŠ¶æ€ï¼šTag \`${VERSION}\`
          - æ¨¡å‹èµ„æºï¼šå›ºå®šå¼•ç”¨è‡ª \`v1.0.0\` ç‰ˆæœ¬ï¼ˆASR / TTS ONNXï¼‰

          <details>
          <summary>ğŸ“ æœ€è¿‘æäº¤è®°å½•</summary>

          ${RECENT_COMMITS}

          </details>
          EOF

      # ========= 9ï¸âƒ£ å‘å¸ƒ Release =========
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.prepare.outputs.version }}
          name: Release ${{ steps.prepare.outputs.version }}
          body_path: release.md
          files: |
            ${{ steps.prepare.outputs.arm32_apk }}
            ${{ steps.prepare.outputs.arm64_apk }}
            ${{ steps.prepare.outputs.x64_apk }}
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
