name: Flutter Admin Webéƒ¨ç½²

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "éƒ¨ç½²åŽŸå› "
        required: false
        default: "æ‰‹åŠ¨è§¦å‘éƒ¨ç½²"

env:
  IMAGE_BASE: ghcr.io/${{ github.repository }}/flutter-admin

jobs:
  deploy:
    name: ðŸ—ï¸ ç¼–è¯‘å¹¶éƒ¨ç½² Flutter Admin
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ èŽ·å–æºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: ðŸ“¦ èŽ·å–ä¾èµ–
        working-directory: flutter_admin
        run: flutter pub get

      - name: ðŸ—ï¸ æž„å»º Web åº”ç”¨
        working-directory: flutter_admin
        run: flutter build web --release

      - name: ðŸ› ï¸ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” ç™»å½• GitHub é•œåƒä»“åº“
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
        id: ver
        run: |
          TAG_FINAL="${GITHUB_SHA:0:8}"
          echo "FLUTTER_ADMIN_IMAGE=${{ env.IMAGE_BASE }}:$TAG_FINAL" >> "$GITHUB_OUTPUT"
          echo "TAG=$TAG_FINAL" >> "$GITHUB_OUTPUT"

      - name: ðŸ“¦ æž„å»ºå¹¶æŽ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./flutter_admin
          file: ./flutter_admin/Dockerfile
          push: true
          tags: |
            ${{ steps.ver.outputs.FLUTTER_ADMIN_IMAGE }}
            ${{ env.IMAGE_BASE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ”‘ é…ç½® SSH å¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          
          cat >> ~/.ssh/config <<EOF
          Host remote-server
              HostName ${{ secrets.SERVER_HOST }}
              User ${{ secrets.SERVER_USER }}
              IdentityFile ~/.ssh/id_rsa
              StrictHostKeyChecking no
              ServerAliveInterval 60
          EOF
          
          echo "Testing SSH Connection..."
          ssh remote-server "echo 'âœ… SSH Connection OK'"

      - name: ðŸŒ æ¿€æ´»è¿œç¨‹ Docker ä¸Šä¸‹æ–‡
        run: |
          docker context create remote-context --docker "host=ssh://remote-server"
          echo "DOCKER_CONTEXT=remote-context" >> $GITHUB_ENV

      - name: ðŸš€ æ‰§è¡Œè¿œç¨‹æ»šåŠ¨éƒ¨ç½²
        env:
          FLUTTER_ADMIN_IMAGE: ${{ steps.ver.outputs.FLUTTER_ADMIN_IMAGE }}
        run: |
          echo "ðŸ”‘ åˆ·æ–°è¿œç¨‹ç™»å½•çŠ¶æ€..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          echo "ðŸ“¡ æ‹‰å–æ–°é•œåƒå¹¶å¯åŠ¨æœåŠ¡..."
          docker compose \
            -f docker/docker-compose.flutter-admin.yml \
            up -d --remove-orphans

      - name: ðŸ©º è¿è¡Œè¿œç¨‹å¥åº·æ£€æŸ¥
        run: |
          echo "ðŸ” æ­£åœ¨ç¡®è®¤æœåŠ¡å¯ç”¨æ€§..."
          success=false
          for i in {1..10}; do
            if curl -f http://localhost:8080 > /dev/null 2>&1; then
              echo "âœ… æœåŠ¡å·²å°±ç»ªï¼"
              success=true
              break
            fi
            echo "â³ æ£€æŸ¥ä¸­ ($i/10)..."
            sleep 6
          done

          if [ "$success" != "true" ]; then
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¾“å‡ºå¼‚å¸¸æ—¥å¿—ï¼š"
            docker compose -f docker/docker-compose.flutter-admin.yml logs --tail 50
            exit 1
          fi

      - name: ðŸ§¹ æ¸…ç†æ—§é•œåƒ
        run: |
          docker image prune -f --filter "until=24h"

      - name: ðŸŽ‰ éƒ¨ç½²å®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "ðŸš€ æˆåŠŸéƒ¨ç½² Flutter Admin ç‰ˆæœ¬: ${{ steps.ver.outputs.TAG }}"
          ssh remote-server "echo ${{ steps.ver.outputs.TAG }} > ~/last_flutter_admin_version.txt"