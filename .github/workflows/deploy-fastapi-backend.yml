name: fastapiåç«¯éƒ¨ç½²

concurrency:
  group: deploy-backend-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "éƒ¨ç½²åŸå› "
        required: false
        default: "æ‰‹åŠ¨è§¦å‘éƒ¨ç½²"

env:
  IMAGE_BASE: ghcr.io/${{ github.repository }}/bipupu-backend

jobs:
  deploy:
    name: ğŸ—ï¸ ç¼–è¯‘å¹¶éƒ¨ç½²
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ“¥ è·å–æºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” ç™»å½• GitHub é•œåƒä»“åº“
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
        id: ver
        run: |
          TAG_FINAL="${GITHUB_SHA:0:8}"
          echo "BACKEND_IMAGE=${{ env.IMAGE_BASE }}:$TAG_FINAL" >> "$GITHUB_OUTPUT"
          echo "TAG=$TAG_FINAL" >> "$GITHUB_OUTPUT"

      - name: ğŸ“¦ æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ steps.ver.outputs.BACKEND_IMAGE }}
            ${{ env.IMAGE_BASE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ”‘ é…ç½® SSH å¯†é’¥
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: ğŸš€ å¼€å¯ SSH å¤šè·¯å¤ç”¨
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          cat >> ~/.ssh/config <<EOF
          Host bipupu-server
            HostName ${{ secrets.SERVER_HOST }}
            User ${{ secrets.SERVER_USER }}
            ControlMaster auto
            ControlPath ~/.ssh/ssh-%r@%h:%p
            ControlPersist 10m
          EOF

      - name: ğŸ’¾ å¤‡ä»½ä¸é¢„å¤„ç†
        run: |
          ssh -o BatchMode=yes -o ConnectTimeout=10 -T bipupu-server 'sh -s' <<'SSH_SCRIPT'
          set -e
          mkdir -p ~/bipupu-backups ~/bipupu-compose
          # å¤‡ä»½å½“å‰é•œåƒåç”¨äºå›æ»š
          CURRENT_IMAGE=$(docker inspect --format='{{.Config.Image}}' bipupu-backend 2>/dev/null || echo "")
          [ -n "$CURRENT_IMAGE" ] && echo "$CURRENT_IMAGE" > ~/bipupu-backups/last-image.txt
          # å¤‡ä»½å½“å‰çš„ compose æ–‡ä»¶
          [ -f ~/bipupu-compose/docker-compose.yml ] && cp ~/bipupu-compose/docker-compose.yml ~/bipupu-backups/compose-bak.yml
          SSH_SCRIPT

      - name: ğŸ“¦ æ¨é€ Docker Compose é…ç½®
        run: |
          # ä»…æ¨é€ä¸»é…ç½®æ–‡ä»¶
          scp backend/docker/docker-compose.yml bipupu-server:~/bipupu-compose/

      - name: ğŸš€ æ‰§è¡Œéƒ¨ç½² (å˜é‡æ³¨å…¥)
        run: |
          ssh -o BatchMode=yes -o ConnectTimeout=10 -T bipupu-server 'sh -s' <<SSH_DEPLOY
          set -e
          cd ~/bipupu-compose

          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # æ•æ„Ÿå˜é‡æ³¨å…¥
          export SECRET_KEY="${{ secrets.SECRET_KEY }}"
          export ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}"
          export ADMIN_USERNAME="${{ secrets.ADMIN_USERNAME }}"
          export BACKEND_IMAGE="${{ steps.ver.outputs.BACKEND_IMAGE }}"

          # å¯åŠ¨æœåŠ¡ï¼Œä¸ä¾èµ– .env å’Œ prod æ–‡ä»¶
          docker compose -p bipupu-backend up -d --remove-orphans
          SSH_DEPLOY

      - name: ğŸ©º å¥åº·æ£€æŸ¥
        run: |
          ssh -o BatchMode=yes -o ConnectTimeout=10 -T bipupu-server 'sh -s' <<'SSH_HEALTH'
          i=1
          while [ "$i" -le 10 ]; do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' bipupu-backend 2>/dev/null || echo "not-found")
            if [ "$STATUS" = "healthy" ]; then
              echo "âœ… æœåŠ¡å·²å°±ç»ª"
              exit 0
            fi
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/10)"
            sleep 10
            i=$((i+1))
          done
          exit 1
          SSH_HEALTH

      - name: ğŸ”„ è‡ªåŠ¨å›æ»š
        if: failure()
        run: |
          ssh -o BatchMode=yes -o ConnectTimeout=10 -T bipupu-server 'sh -s' <<SSH_ROLLBACK
          set -e
          if [ -f ~/bipupu-backups/last-image.txt ]; then
            PREVIOUS_IMAGE=$(cat ~/bipupu-backups/last-image.txt)
            [ -f ~/bipupu-backups/compose-bak.yml ] && cp ~/bipupu-backups/compose-bak.yml ~/bipupu-compose/docker-compose.yml

            cd ~/bipupu-compose
            export SECRET_KEY="${{ secrets.SECRET_KEY }}"
            export ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}"
            export ADMIN_USERNAME="${{ secrets.ADMIN_USERNAME }}"
            export BACKEND_IMAGE="\$PREVIOUS_IMAGE"

            docker compose -p bipupu-backend up -d
            echo "ğŸ”„ å·²å›æ»šè‡³ä¸Šæ¬¡ç¨³å®šç‰ˆæœ¬"
          fi
          SSH_ROLLBACK

      - name: ğŸ§¹ æ¸…ç†æ—§é•œåƒ
        if: always()
        run: |
          ssh -o BatchMode=yes -o ConnectTimeout=10 -T bipupu-server "docker image prune -f --filter 'until=48h'"