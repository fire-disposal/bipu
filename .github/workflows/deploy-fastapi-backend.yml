name: fastapiåŽç«¯éƒ¨ç½²

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "éƒ¨ç½²åŽŸå› "
        required: false
        default: "æ‰‹åŠ¨è§¦å‘éƒ¨ç½²"

env:
  IMAGE_BASE: ghcr.io/${{ github.repository }}/bipupu-backend

jobs:
  deploy:
    name: ðŸ—ï¸ ç¼–è¯‘å¹¶éƒ¨ç½²
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write

    env:
      # å…¨å±€æ³¨å…¥æ•æ„Ÿé…ç½®ï¼Œç¡®ä¿éƒ¨ç½²ã€å¥åº·æ£€æŸ¥å’Œæ—¥å¿—æŸ¥çœ‹çš„æ‰€æœ‰æ­¥éª¤éƒ½èƒ½è®¿é—®
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}

    steps:
      - name: ðŸ“¥ èŽ·å–æºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” ç™»å½• GitHub é•œåƒä»“åº“
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
        id: ver
        run: |
          TAG_FINAL="${GITHUB_SHA:0:8}"
          echo "BACKEND_IMAGE=${{ env.IMAGE_BASE }}:$TAG_FINAL" >> "$GITHUB_OUTPUT"
          echo "TAG=$TAG_FINAL" >> "$GITHUB_OUTPUT"

      - name: ðŸ“¦ æž„å»ºå¹¶æŽ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ steps.ver.outputs.BACKEND_IMAGE }}
            ${{ env.IMAGE_BASE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ”‘ é…ç½® SSH å¯†é’¥ (ç›´æŽ¥æ–‡ä»¶æ¨¡å¼)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # æ‰«ææŒ‡çº¹
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          
          # ä½¿ç”¨ EOF è¯­æ³•ä¸€æ¬¡æ€§å†™å…¥ configï¼Œæ›´æ•´æ´
          cat >> ~/.ssh/config <<EOF
          Host remote-server
              HostName ${{ secrets.SERVER_HOST }}
              User ${{ secrets.SERVER_USER }}
              IdentityFile ~/.ssh/id_rsa
              StrictHostKeyChecking no
              ServerAliveInterval 60
          EOF
          
          echo "Testing SSH Connection..."
          ssh remote-server "echo 'âœ… SSH Connection OK'"

      - name: ðŸŒ æ¿€æ´»è¿œç¨‹ Docker ä¸Šä¸‹æ–‡
        run: |
          # ä½¿ç”¨ config ä¸­å®šä¹‰çš„ Host åˆ«å
          docker context create remote-context --docker "host=ssh://remote-server"
          # æŒä¹…åŒ–ä¸Šä¸‹æ–‡é€‰æ‹©åˆ°çŽ¯å¢ƒå˜é‡ï¼Œç¡®ä¿åŽç»­æ­¥éª¤ç”Ÿæ•ˆ
          echo "DOCKER_CONTEXT=remote-context" >> $GITHUB_ENV

      - name: ðŸ” é¢„æ£€æŸ¥ Secrets é…ç½®
        run: |
          # æ£€æŸ¥å…³é”®å˜é‡æ˜¯å¦ä¸ºç©ºï¼ˆä¸æ‰“å°å€¼ï¼‰
          if [[ -z "$SECRET_KEY" || -z "$POSTGRES_PASSWORD" || -z "$ADMIN_EMAIL" ]]; then
            echo "::error::å…³é”® Secrets æœªè®¾ç½®ï¼è¯·æ£€æŸ¥ GitHub ä»“åº“ Settings -> Secrets -> Actions"
            echo "ç¼ºå°‘: SECRET_KEY, POSTGRES_PASSWORD æˆ– ADMIN_EMAIL"
            exit 1
          fi
          echo "âœ… Secrets æ ¼å¼æ£€æŸ¥é€šè¿‡"

      - name: ðŸš€ æ‰§è¡Œè¿œç¨‹æ»šåŠ¨éƒ¨ç½²
        env:
          BACKEND_IMAGE: ${{ steps.ver.outputs.BACKEND_IMAGE }}
        run: |
          echo "ðŸ”‘ åˆ·æ–°è¿œç¨‹ç™»å½•çŠ¶æ€..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          echo "ðŸ“ ç”Ÿæˆç”Ÿäº§çŽ¯å¢ƒ .env æ–‡ä»¶..."
          # åœ¨ GitHub Runner æœ¬åœ°ç”Ÿæˆ .envï¼Œdocker compose ä¼šè¯»å–å¹¶å°†å…¶å†…å®¹æŽ¨é€åˆ°è¿œç¨‹å®¹å™¨
          cat > backend/docker/.env <<EOF
          BIPUPU_SECRET_KEY=$SECRET_KEY
          BIPUPU_POSTGRES_PASSWORD=$POSTGRES_PASSWORD
          BIPUPU_ADMIN_EMAIL=$ADMIN_EMAIL
          BIPUPU_ADMIN_PASSWORD=$ADMIN_PASSWORD
          BIPUPU_ADMIN_USERNAME=$ADMIN_USERNAME
          BIPUPU_LOG_LEVEL=INFO
          EOF

          echo "ðŸ“¡ æ‹‰å–æ–°é•œåƒå¹¶å¯åŠ¨æœåŠ¡..."
          docker compose \
            -f backend/docker/docker-compose.yml \
            -f backend/docker/docker-compose.prod.yml \
            -p bipupu-backend \
            up -d --remove-orphans

      - name: ðŸ©º è¿è¡Œè¿œç¨‹å¥åº·æ£€æŸ¥
        run: |
          echo "ðŸ” æ­£åœ¨é€šè¿‡ Docker çŠ¶æ€ç¡®è®¤æœåŠ¡å¯ç”¨æ€§ (æœ€å¤š 5 æ¬¡)..."
          for i in {1..5}; do
            # èŽ·å–å®¹å™¨å¥åº·çŠ¶æ€ï¼šhealthy, unhealthy, starting
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' bipupu-backend 2>/dev/null || echo "not-found")
            
            if [ "$STATUS" == "healthy" ]; then
              echo "âœ… æœåŠ¡å·²å°±ç»ª (çŠ¶æ€: $STATUS)"
              exit 0
            fi
            
            echo "â³ æ£€æŸ¥ä¸­ ($i/5): å½“å‰çŠ¶æ€ä¸º $STATUS..."
            # æ­¥é•¿ç¨å¾®æ‹‰é•¿ä¸€ç‚¹ï¼Œç»™å®¹å™¨å¯åŠ¨æ—¶é—´
            sleep 12
          done

          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥æˆ–è¶…æ—¶ï¼"
          echo "ðŸ“Š å®¹å™¨å½“å‰è¯¦ç»†çŠ¶æ€ï¼š"
          docker inspect --format='çŠ¶æ€: {{.State.Status}}, å¥åº·: {{.State.Health.Status}}, é€€å‡ºç : {{.State.ExitCode}}' bipupu-backend
          
          echo "ðŸ“ è¾“å‡ºå¼‚å¸¸æ—¥å¿— (æœ€åŽ 100 è¡Œ)ï¼š"
          docker logs bipupu-backend --tail 100
          
          # å¦‚æžœæ­¤æ—¶è¿˜æœ‰æ­£åœ¨è¿è¡Œä½†çŠ¶æ€ä¸ä½³çš„å®¹å™¨ï¼Œå°†å…¶åœæ­¢ä»¥ä¾¿åŽç»­é‡è¯•
          exit 1

      - name: ðŸ§¹ æ¸…ç†æ—§é•œåƒ
        run: |
          # è‡ªåŠ¨åˆ é™¤æœåŠ¡å™¨ä¸Šè¶…è¿‡ 24 å°æ—¶çš„æ— ç”¨é•œåƒï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´
          docker image prune -f --filter "until=24h"

      - name: ðŸŽ‰ éƒ¨ç½²å®Œæˆé€šçŸ¥
        if: success() # ç¡®ä¿åªæœ‰æˆåŠŸæ—¶æ‰è®°å½•
        run: |
          echo "ðŸš€ æˆåŠŸéƒ¨ç½²ç‰ˆæœ¬: ${{ steps.ver.outputs.TAG }}"
          # ç›´æŽ¥ä½¿ç”¨åˆ«åè¿œç¨‹å†™å…¥
          ssh remote-server "echo ${{ steps.ver.outputs.TAG }} > ~/last_version.txt"