name: fastapiåç«¯éƒ¨ç½²

concurrency:
  group: deploy-backend-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "éƒ¨ç½²åŸå› "
        required: false
        default: "æ‰‹åŠ¨è§¦å‘éƒ¨ç½²"

env:
  IMAGE_BASE: ghcr.io/${{ github.repository }}/bipupu-backend

jobs:
  deploy:
    name: ğŸ—ï¸ ç¼–è¯‘å¹¶éƒ¨ç½²
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ“¥ è·å–æºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” ç™»å½• GitHub é•œåƒä»“åº“
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
        id: ver
        run: |
          TAG_FINAL="${GITHUB_SHA:0:8}"
          echo "BACKEND_IMAGE=${{ env.IMAGE_BASE }}:$TAG_FINAL" >> "$GITHUB_OUTPUT"
          echo "TAG=$TAG_FINAL" >> "$GITHUB_OUTPUT"

      - name: ğŸ“¦ æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ steps.ver.outputs.BACKEND_IMAGE }}
            ${{ env.IMAGE_BASE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ”‘ é…ç½® SSH å¯†é’¥ï¼ˆé€šè¿‡ ssh-agentï¼‰
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: ğŸ“ æ·»åŠ  SSH Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: ğŸ§ª éªŒè¯ SSH è¿æ¥
        run: |
          ssh -o ConnectTimeout=5 \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "echo 'âœ… SSH Connection OK'"

      - name: ğŸ“ éªŒè¯ Secrets é…ç½®
        run: |
          # æ£€æŸ¥å¿…éœ€çš„ secrets æ˜¯å¦å­˜åœ¨
          if [[ -z "${{ secrets.SECRET_KEY }}" || -z "${{ secrets.ADMIN_PASSWORD }}" || -z "${{ secrets.ADMIN_USERNAME }}" ]]; then
            echo "::error::å…³é”® Secrets æœªè®¾ç½®ï¼"
            echo "ç¼ºå°‘: SECRET_KEYã€ADMIN_PASSWORD æˆ– ADMIN_USERNAME"
            exit 1
          fi
          echo "âœ… Secrets éªŒè¯é€šè¿‡"

      - name: ğŸ’¾ å¤‡ä»½å½“å‰é•œåƒä¿¡æ¯å’Œ compose æ–‡ä»¶ï¼ˆç”¨äºå›æ»šï¼‰
        run: |
          echo "ğŸ“¦ å¤‡ä»½å½“å‰è¿è¡Œçš„é•œåƒä¿¡æ¯å’Œ compose æ–‡ä»¶..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} <<'SSH_SCRIPT'
          set -e
          BACKUP_DIR="$HOME/bipupu-backups"
          mkdir -p "$BACKUP_DIR"
          CURRENT_IMAGE=$(docker inspect --format='{{.Config.Image}}' bipupu-backend 2>/dev/null || echo "")
          if [ -n "$CURRENT_IMAGE" ]; then
            echo "$CURRENT_IMAGE" > "$BACKUP_DIR/last-image.txt"
            echo "âœ… å·²ä¿å­˜å½“å‰é•œåƒ: $CURRENT_IMAGE"
          else
            echo "âš ï¸ å½“å‰æ²¡æœ‰è¿è¡Œçš„å®¹å™¨"
          fi
          # å¤‡ä»½ compose æ–‡ä»¶
          if [ -d ~/bipupu-compose ]; then
            mkdir -p "$BACKUP_DIR/compose-backup"
            cp ~/bipupu-compose/docker-compose.yml "$BACKUP_DIR/compose-backup/" 2>/dev/null || true
            cp ~/bipupu-compose/docker-compose.prod.yml "$BACKUP_DIR/compose-backup/" 2>/dev/null || true
            echo "âœ… å·²å¤‡ä»½ compose æ–‡ä»¶"
          else
            echo "âš ï¸ compose ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
          fi
          SSH_SCRIPT
      - name: ğŸ“¦ æ¨é€ docker-compose é…ç½®åˆ°è¿œç¨‹æœåŠ¡å™¨
        run: |
          scp backend/docker/docker-compose.yml \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/bipupu-compose/

          scp backend/docker/docker-compose.prod.yml \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/bipupu-compose/

          echo "âœ… é…ç½®æ–‡ä»¶å·²æ¨é€"

      - name: ğŸš€ åœ¨è¿œç¨‹ä¸»æœºæ‰§è¡Œéƒ¨ç½²
        env:
          BACKEND_IMAGE: ${{ steps.ver.outputs.BACKEND_IMAGE }}
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} <<'SSH_DEPLOY'
          set -e

          echo "ğŸ” ç™»å½•é•œåƒä»“åº“..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          echo "ğŸ“ å‡†å¤‡éƒ¨ç½²ç›®å½•..."
          mkdir -p ~/bipupu-compose
          cd ~/bipupu-compose

          echo "ğŸ“ ç”Ÿæˆç¯å¢ƒé…ç½®æ–‡ä»¶..."
          cat > .env <<'ENV_EOF'
          # æ•°æ®åº“é…ç½® (å†…ç½‘ä»…è®¿é—®)
          DB_USER=postgres
          DB_NAME=bipupu

          # åº”ç”¨æ•æ„Ÿé…ç½®
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}

          # æ—¥å¿—çº§åˆ«
          LOG_LEVEL=INFO
          TZ=Asia/Shanghai
          ENV_EOF

          echo "ğŸ“¡ æ‹‰å–æ–°é•œåƒ..."
          docker pull ${{ env.IMAGE_BASE }}:latest

          echo "ğŸš€ å¯åŠ¨æœåŠ¡ (åº”ç”¨æ–°é•œåƒ)..."
          docker compose \
            -f docker-compose.yml \
            -f docker-compose.prod.yml \
            --env-file .env \
            -p bipupu-backend \
            up -d --remove-orphans

          echo "âœ… éƒ¨ç½²å‘½ä»¤å·²æ‰§è¡Œ"
          SSH_DEPLOY

      - name: ğŸ©º è¿è¡Œè¿œç¨‹å¥åº·æ£€æŸ¥
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} <<'SSH_HEALTH'
          set -e

          echo "ğŸ” æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€ (æœ€å¤š 10 æ¬¡)..."
          for i in {1..10}; do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' bipupu-backend 2>/dev/null || echo "not-found")
            
            if [ "$STATUS" == "healthy" ]; then
              echo "âœ… æœåŠ¡å·²å°±ç»ª (çŠ¶æ€: $STATUS)"
              exit 0
            fi
            
            echo "â³ æ£€æŸ¥ä¸­ ($i/10): å½“å‰çŠ¶æ€ä¸º $STATUS..."
            sleep 12
          done

          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥æˆ–è¶…æ—¶ï¼"
          echo "ğŸ“Š å®¹å™¨è¯¦ç»†çŠ¶æ€ï¼š"
          docker inspect --format='çŠ¶æ€: {{.State.Status}}, å¥åº·: {{.State.Health.Status}}, é€€å‡ºç : {{.State.ExitCode}}' bipupu-backend

          echo "ğŸ“ åº”ç”¨æ—¥å¿— (æœ€å 50 è¡Œ)ï¼š"
          docker logs bipupu-backend --tail 50

          exit 1
          SSH_HEALTH

      - name: ğŸ”„ è‡ªåŠ¨å›æ»šï¼ˆå½“å¥åº·æ£€æŸ¥å¤±è´¥æ—¶ï¼‰
        if: failure()
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} <<'SSH_ROLLBACK'
          set -e

          echo "ğŸ”„ æ£€æµ‹åˆ°éƒ¨ç½²å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š..."

          # è¯»å–ä¹‹å‰ä¿å­˜çš„é•œåƒ
          BACKUP_DIR="$HOME/bipupu-backups"
          if [ ! -f "$BACKUP_DIR/last-image.txt" ]; then
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½é•œåƒä¿¡æ¯ï¼Œæ— æ³•å›æ»š"
            exit 0
          fi

          PREVIOUS_IMAGE=$(cat "$BACKUP_DIR/last-image.txt")
          echo "ğŸ“¦ å›æ»šåˆ°é•œåƒ: $PREVIOUS_IMAGE"

          # æ¢å¤å¤‡ä»½çš„ compose æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "$BACKUP_DIR/compose-backup" ]; then
            echo "ğŸ“¦ æ¢å¤å¤‡ä»½çš„ compose æ–‡ä»¶..."
            mkdir -p ~/bipupu-compose
            cp "$BACKUP_DIR/compose-backup/docker-compose.yml" ~/bipupu-compose/ 2>/dev/null || true
            cp "$BACKUP_DIR/compose-backup/docker-compose.prod.yml" ~/bipupu-compose/ 2>/dev/null || true
            echo "âœ… compose æ–‡ä»¶å·²æ¢å¤"
          else
            echo "âš ï¸ æ²¡æœ‰å¤‡ä»½çš„ compose æ–‡ä»¶ï¼Œä½¿ç”¨å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶"
          fi

          cd ~/bipupu-compose

          export BACKEND_IMAGE="$PREVIOUS_IMAGE"
          docker compose \
            -f docker-compose.yml \
            -f docker-compose.prod.yml \
            --env-file .env \
            -p bipupu-backend \
            up -d --remove-orphans

          echo "âœ… å›æ»šå·²æ‰§è¡Œï¼Œç­‰å¾…æœåŠ¡æ¢å¤..."
          sleep 30

          STATUS=$(docker inspect --format='{{.State.Health.Status}}' bipupu-backend 2>/dev/null || echo "not-found")
          if [ "$STATUS" == "healthy" ]; then
            echo "âœ… å›æ»šæˆåŠŸï¼ŒæœåŠ¡å·²æ¢å¤å¥åº·"
          else
            echo "âš ï¸ å›æ»šåå®¹å™¨çŠ¶æ€ä¸º $STATUSï¼Œéœ€è¦æ‰‹åŠ¨æ£€æŸ¥"
          fi
          SSH_ROLLBACK

      - name: ğŸ§¹ æ¸…ç†æ—§é•œåƒ
        if: success()
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} <<'SSH_CLEANUP'
          # åˆ é™¤è¶…è¿‡ 48 å°æ—¶çš„æ— ç”¨é•œåƒï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´
          docker image prune -f --filter "until=48h"
          echo "âœ… æ—§é•œåƒå·²æ¸…ç†"
          SSH_CLEANUP

      - name: ğŸ‰ éƒ¨ç½²å®Œæˆé€šçŸ¥
        if: success()
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} <<'SSH_NOTIFY'
          mkdir -p ~/bipupu-backups
          echo "${{ steps.ver.outputs.TAG }}" > ~/bipupu-backups/last-version.txt
          echo "âœ… éƒ¨ç½²å®Œæˆï¼šç‰ˆæœ¬ ${{ steps.ver.outputs.TAG }}"
          SSH_NOTIFY
