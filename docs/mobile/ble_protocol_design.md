# Bipupu 蓝牙协议设计文档

## 概述

本协议设计用于 Bipupu 移动应用与蓝牙设备之间的高效通信。协议遵循以下核心原则：
1. **尽可能简单** - 最小化协议复杂度
2. **发送人与消息内容分离** - 支持单独传输发送人标识
3. **无电量回报** - 不包含设备电量状态上报

## 协议格式

### 基础协议头
所有消息共享相同的基础协议头：
```
[协议版本:1字节][消息类型:1字节]
```

### 消息类型定义
| 类型值 | 名称 | 方向 | 描述 |
|--------|------|------|------|
| 0x01 | 时间同步 | 手机 → 设备 | 发送当前时间到设备 |
| 0x02 | 文本消息 | 手机 → 设备 | 发送文本消息到设备 |
| 0x03 | 确认响应 | 设备 → 手机 | 设备对收到消息的确认 |

### 状态码定义
| 状态值 | 名称 | 描述 |
|--------|------|------|
| 0x00 | 成功 | 消息处理成功 |
| 0x01 | 格式错误 | 消息格式不正确 |
| 0x02 | 不支持的消息类型 | 设备不支持该消息类型 |
| 0x03 | 设备忙 | 设备当前繁忙 |

## 详细消息格式

### 1. 时间同步消息 (0x01)
**格式：**
```
[版本:1][类型:1=0x01][Unix时间戳:4字节]
```
**总长度：** 6字节

**示例：**
```
01 01 5F 3B 9A 60  // 版本1，类型1，时间戳1598882400
```

**说明：**
- 时间戳为 Unix 时间戳（秒）
- 在蓝牙连接成功后自动发送
- 用于设备电子钟同步

### 2. 文本消息 (0x02)
**格式：**
```
[版本:1][类型:1=0x02][发送人ID长度:1][发送人ID...][消息内容...]
```
**总长度：** 可变，最大240字节

**字段说明：**
- **发送人ID长度**：1字节，表示发送人ID的字节数（0-255）
- **发送人ID**：UTF-8编码的字符串，长度由前一个字段指定
- **消息内容**：UTF-8编码的文本消息

**示例：**
```
01 02 08 75 73 65 72 5F 31 32 33 48 65 6C 6C 6F 20 57 6F 72 6C 64
// 版本1，类型2，发送人ID长度8，发送人ID="user_123"，消息内容="Hello World"
```

**设计特点：**
- 发送人ID和消息内容明确分离
- 支持任意UTF-8文本
- 自动处理消息分片（如果需要）

### 3. 确认响应 (0x03)
**格式：**
```
[版本:1][类型:1=0x03][原始消息类型:1][状态码:1]
```
**总长度：** 4字节

**示例：**
```
01 03 02 00  // 版本1，类型3，原始消息类型2，状态码0（成功）
```

**说明：**
- 设备收到消息后必须发送确认
- 包含原始消息类型便于匹配
- 状态码指示处理结果

## 蓝牙服务配置

### UUID配置（使用 Nordic UART Service）
| 服务/特征 | UUID | 方向 | 描述 |
|-----------|------|------|------|
| 主服务 | `6E400001-B5A3-F393-E0A9-E50E24DCCA9E` | - | 主通信服务 |
| 写特征 | `6E400002-B5A3-F393-E0A9-E50E24DCCA9E` | 手机 → 设备 | 发送消息到设备 |
| 通知特征 | `6E400003-B5A3-F393-E0A9-E50E24DCCA9E` | 设备 → 手机 | 接收设备通知 |

### MTU配置
- **最大MTU**：512字节（BLE标准）
- **最大消息长度**：240字节（预留协议开销）
- **消息分片**：如果消息超过MTU，应用层自动分片

## 通信流程

### 1. 连接建立流程
```
手机 → 扫描并连接设备
手机 → 订阅通知特征
手机 → 发送时间同步消息 (0x01)
设备 → 发送确认响应 (0x03)
连接建立完成
```

### 2. 消息转发流程
```
服务器 → 新消息到达
手机 → 通过轮询获取新消息
手机 → 编码为文本消息 (0x02)
手机 → 发送到所有连接的设备
设备 → 处理消息并显示
设备 → 发送确认响应 (0x03)
手机 → 记录发送状态
```

### 3. 错误处理流程
```
手机 → 发送消息
设备 → 检测到错误
设备 → 发送确认响应（错误状态码）
手机 → 根据错误码决定重试或丢弃
```

## 实现架构

### 核心组件
1. **BleProtocol** - 协议编码/解码
2. **BleProtocolService** - 协议服务管理
3. **MessageForwarder** - 消息转发引擎
4. **AppLifecycleManager** - 应用生命周期管理

### 数据流
```
轮询服务 → 新消息 → 消息转发服务 → 蓝牙协议服务 → 蓝牙设备
                                      ↓
                                协议编码/解码
                                      ↓
                                设备确认响应
```

## 性能优化

### 1. 消息队列管理
- 每个设备独立的消息队列
- 顺序发送，避免冲突
- 超时重试机制

### 2. 连接状态管理
- 自动检测设备连接/断开
- 连接成功后自动时间同步
- 断线自动清理资源

### 3. 内存优化
- 使用二进制协议，最小化数据大小
- 及时释放不再使用的资源
- 限制队列长度，防止内存泄漏

## 错误处理策略

### 1. 协议错误
- 版本不匹配：拒绝处理
- 消息格式错误：返回格式错误状态码
- 不支持的消息类型：返回不支持状态码

### 2. 传输错误
- 发送超时：自动重试（最多3次）
- 设备忙：等待后重试
- 连接断开：清理队列并等待重连

### 3. 应用错误
- 服务启动失败：显示错误界面
- 蓝牙权限不足：提示用户授权
- 设备不支持：跳过该设备

## 测试验证

### 1. 单元测试
- 协议编码/解码正确性
- 消息队列管理逻辑
- 错误处理流程

### 2. 集成测试
- 完整消息转发流程
- 多设备同时连接
- 网络中断恢复

### 3. 性能测试
- 消息吞吐量测试
- 内存使用监控
- 电池消耗评估

## 部署要求

### 1. 设备要求
- 支持蓝牙4.0或更高版本
- 支持 Nordic UART Service
- 足够的处理能力解析协议

### 2. 应用要求
- Android 6.0+ / iOS 10.0+
- 蓝牙权限
- 后台运行权限（可选）

### 3. 配置要求
- 正确的UUID配置
- 适当的MTU设置
- 合理的超时时间

## 版本历史

### v1.0 (当前)
- 基础协议框架
- 时间同步功能
- 文本消息转发
- 确认响应机制

### 未来扩展
- 二进制数据支持
- 设备命令控制
- 固件升级支持
- 数据加密传输

---

**设计者：** Bipupu 工程团队  
**最后更新：** 2024年  
**协议版本：** 1.0