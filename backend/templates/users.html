{% extends "base.html" %} {% block title %}用户管理 - Bipupu 管理后台{% endblock
%} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>用户管理</h2>
    <button class="btn btn-primary" onclick="refreshUsers()">刷新</button>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>用户名</th>
                        <!-- 邮箱字段已移除 -->
                        <th>状态</th>
                        <th>注册时间</th>
                        <th>最后登录</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.username }}</td>
                        <td>—</td>
                        <td>
                            {% if user.is_active %}
                            <span class="badge bg-success">活跃</span>
                            {% else %}
                            <span class="badge bg-danger">禁用</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ user.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </td>
                        <td>
                            {% if user.last_login_at %} {{
                            user.last_login_at.strftime('%Y-%m-%d %H:%M') }} {%
                            else %} 从未登录 {% endif %}
                        </td>
                        <td>
                            <button
                                class="btn btn-sm btn-outline-primary"
                                data-user-id="{{ user.id }}"
                                onclick="viewUser(this)"
                            >
                                查看
                            </button>
                            {% if user.is_active %}
                            <button
                                class="btn btn-sm btn-outline-warning"
                                data-user-id="{{ user.id }}"
                                data-action="disable"
                                onclick="toggleUser(this)"
                            >
                                禁用
                            </button>
                            {% else %}
                            <button
                                class="btn btn-sm btn-outline-success"
                                data-user-id="{{ user.id }}"
                                data-action="enable"
                                onclick="toggleUser(this)"
                            >
                                启用
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <nav aria-label="用户列表分页" class="mt-3">
            <ul class="pagination justify-content-center">
                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page - 1 }}">上一页</a>
                </li>
                {% endif %} {% set start_page = page - 2 %} {% if start_page < 1
                %} {% set start_page = 1 %} {% endif %} {% set end_page = page +
                2 %} {% if end_page > total_pages %} {% set end_page =
                total_pages %} {% endif %} {% for page_num in range(start_page,
                end_page + 1) %}
                <li
                    class="page-item {% if page_num == page %}active{% endif %}"
                >
                    <a class="page-link" href="?page={{ page_num }}"
                        >{{ page_num }}</a
                    >
                </li>
                {% endfor %} {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page + 1 }}">下一页</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    async function toggleUser(button) {
        const userId = button.getAttribute("data-user-id");
        const action = button.getAttribute("data-action");
        const activate = action === "enable";

        const actionText = activate ? "启用" : "禁用";
        if (!confirm(`确定要${actionText}这个用户吗？`)) return;

        try {
            const response = await fetch(`/admin/users/${userId}/toggle`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
            });

            if (response.ok) {
                location.reload();
            } else {
                alert("操作失败");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("操作失败");
        }
    }

    function viewUser(button) {
        const userId = button.getAttribute("data-user-id");
        window.open(`/admin/users/${userId}`, "_blank");
    }

    function refreshUsers() {
        location.reload();
    }
</script>
{% endblock %}
