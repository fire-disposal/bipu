{% extends "base.html" %}

{% block title %}消息推送日志 - Bipupu 管理后台{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>消息推送日志</h2>
    <div class="btn-group" role="group">
        <button class="btn btn-outline-secondary" onclick="filterByStatus('all')">全部</button>
        <button class="btn btn-outline-success" onclick="filterByStatus('success')">成功</button>
        <button class="btn btn-outline-danger" onclick="filterByStatus('failed')">失败</button>
        <button class="btn btn-outline-warning" onclick="filterByStatus('processing')">处理中</button>
        <button class="btn btn-primary" onclick="refreshLogs()">刷新</button>
    </div>
</div>

<!-- 统计卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">总推送数</h6>
                <h3 class="card-text text-primary">{{ stats.total }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">成功</h6>
                <h3 class="card-text text-success">{{ stats.success }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">失败</h6>
                <h3 class="card-text text-danger">{{ stats.failed }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">成功率</h6>
                <h3 class="card-text text-info">
                    {% if stats.total > 0 %}
                        {{ "%.1f"|format((stats.success / stats.total) * 100) }}%
                    {% else %}
                        0%
                    {% endif %}
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- 推送日志表格 -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>服务号</th>
                        <th>接收者</th>
                        <th>状态</th>
                        <th>内容预览</th>
                        <th>任务ID</th>
                        <th>创建时间</th>
                        <th>完成时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% if logs %}
                        {% for log in logs %}
                        <tr>
                            <td>{{ log.id }}</td>
                            <td>
                                <span class="badge bg-info">{{ log.service_name }}</span>
                            </td>
                            <td>{{ log.receiver_bipupu_id }}</td>
                            <td>
                                {% if log.status == 'success' %}
                                    <span class="badge bg-success">✓ 成功</span>
                                {% elif log.status == 'failed' %}
                                    <span class="badge bg-danger">✗ 失败</span>
                                {% elif log.status == 'processing' %}
                                    <span class="badge bg-warning">⟳ 处理中</span>
                                {% elif log.status == 'pending' %}
                                    <span class="badge bg-secondary">⏳ 待推送</span>
                                {% elif log.status == 'skipped' %}
                                    <span class="badge bg-light text-dark">⊘ 跳过</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.content_preview %}
                                    <small class="text-muted">
                                        {% if log.content_preview|length > 50 %}
                                            {{ log.content_preview[:50] }}...
                                        {% else %}
                                            {{ log.content_preview }}
                                        {% endif %}
                                    </small>
                                {% else %}
                                    <em class="text-muted">无内容</em>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.task_id %}
                                    <small class="text-monospace">{{ log.task_id[:12] }}...</small>
                                {% else %}
                                    <em class="text-muted">-</em>
                                {% endif %}
                            </td>
                            <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>
                                {% if log.completed_at %}
                                    {{ log.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                {% else %}
                                    <em class="text-muted">-</em>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="viewLogDetail('{{ log.id }}')">
                                    详情
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            暂无推送日志
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        {% if total_pages > 1 %}
        <nav aria-label="推送日志分页" class="mt-3">
            <ul class="pagination justify-content-center">
                {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page - 1 }}">上一页</a>
                    </li>
                {% endif %}

                {% set start_page = page - 2 %}
                {% if start_page < 1 %}
                    {% set start_page = 1 %}
                {% endif %}
                {% set end_page = page + 2 %}
                {% if end_page > total_pages %}
                    {% set end_page = total_pages %}
                {% endif %}

                {% for page_num in range(start_page, end_page + 1) %}
                    <li class="page-item {% if page_num == page %}active{% endif %}">
                        <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                    </li>
                {% endfor %}

                {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page + 1 }}">下一页</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- 日志详情模态框 -->
<div class="modal fade" id="logDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">推送日志详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="logDetailContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let logDetailModal = null;

document.addEventListener('DOMContentLoaded', function() {
    logDetailModal = new bootstrap.Modal(document.getElementById('logDetailModal'));
});

function filterByStatus(status) {
    if (status === 'all') {
        window.location.href = '?page=1';
    } else {
        window.location.href = `?page=1&status=${status}`;
    }
}

function refreshLogs() {
    location.reload();
}

async function viewLogDetail(logId) {
    const contentEl = document.getElementById('logDetailContent');
    contentEl.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">加载中...</span></div></div>';
    
    try {
        const response = await fetch(`/admin/push_logs/${logId}/detail`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        
        let statusBadge = '';
        if (data.status === 'success') {
            statusBadge = '<span class="badge bg-success">✓ 成功</span>';
        } else if (data.status === 'failed') {
            statusBadge = '<span class="badge bg-danger">✗ 失败</span>';
        } else if (data.status === 'processing') {
            statusBadge = '<span class="badge bg-warning">⟳ 处理中</span>';
        } else if (data.status === 'pending') {
            statusBadge = '<span class="badge bg-secondary">⏳ 待推送</span>';
        } else if (data.status === 'skipped') {
            statusBadge = '<span class="badge bg-light text-dark">⊘ 跳过</span>';
        }
        
        let duration = '-';
        if (data.started_at && data.completed_at) {
            const start = new Date(data.started_at);
            const end = new Date(data.completed_at);
            const ms = end - start;
            duration = `${ms}ms`;
        }
        
        let html = `
            <dl class="row">
                <dt class="col-sm-3">日志ID</dt>
                <dd class="col-sm-9">${data.id}</dd>
                
                <dt class="col-sm-3">服务号</dt>
                <dd class="col-sm-9"><span class="badge bg-info">${data.service_name}</span></dd>
                
                <dt class="col-sm-3">接收者</dt>
                <dd class="col-sm-9">${data.receiver_bipupu_id}</dd>
                
                <dt class="col-sm-3">状态</dt>
                <dd class="col-sm-9">${statusBadge}</dd>
                
                <dt class="col-sm-3">任务ID</dt>
                <dd class="col-sm-9"><code>${data.task_id || '-'}</code></dd>
                
                <dt class="col-sm-3">任务名称</dt>
                <dd class="col-sm-9">${data.task_name || '-'}</dd>
                
                <dt class="col-sm-3">创建时间</dt>
                <dd class="col-sm-9">${new Date(data.created_at).toLocaleString()}</dd>
                
                <dt class="col-sm-3">开始时间</dt>
                <dd class="col-sm-9">${data.started_at ? new Date(data.started_at).toLocaleString() : '-'}</dd>
                
                <dt class="col-sm-3">完成时间</dt>
                <dd class="col-sm-9">${data.completed_at ? new Date(data.completed_at).toLocaleString() : '-'}</dd>
                
                <dt class="col-sm-3">耗时</dt>
                <dd class="col-sm-9">${duration}</dd>
                
                <dt class="col-sm-3">重试次数</dt>
                <dd class="col-sm-9">${data.retry_count} / ${data.max_retries}</dd>
        `;
        
        if (data.content_preview) {
            html += `
                <dt class="col-sm-3">内容预览</dt>
                <dd class="col-sm-9">
                    <div class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto;">
                        <small>${escapeHtml(data.content_preview)}</small>
                    </div>
                </dd>
            `;
        }
        
        if (data.error_message) {
            html += `
                <dt class="col-sm-3">错误信息</dt>
                <dd class="col-sm-9">
                    <div class="alert alert-danger mb-0">
                        <small><code>${escapeHtml(data.error_message)}</code></small>
                    </div>
                </dd>
            `;
        }
        
        if (data.metadata) {
            html += `
                <dt class="col-sm-3">元数据</dt>
                <dd class="col-sm-9">
                    <pre class="bg-light p-2 rounded"><small>${JSON.stringify(data.metadata, null, 2)}</small></pre>
                </dd>
            `;
        }
        
        html += '</dl>';
        
        contentEl.innerHTML = html;
        logDetailModal.show();
    } catch (error) {
        contentEl.innerHTML = `<div class="alert alert-danger">加载失败: ${error.message}</div>`;
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>
{% endblock %}
