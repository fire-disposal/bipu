{% extends "base.html" %}

{% block title %}API 测试 (消息) - Bipupu 管理后台{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>API 测试 (消息)</h2>
    <div>
        <span class="badge bg-info">当前身份: {{ user.username }} ({{ user.bipupu_id }})</span>
    </div>
</div>

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}
{% if success %}
<div class="alert alert-success">{{ success }}</div>
{% endif %}

<div class="row">
    <!-- 发送消息表单 -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                发送消息
            </div>
            <div class="card-body">
                <form action="/admin/test_chat/send" method="post">
                    <div class="mb-3">
                        <label for="receiver_id" class="form-label">接收者 ID</label>
                        <input type="text" class="form-control" id="receiver_id" name="receiver_id" placeholder="用户BipupuID 或 服务号名称" required>
                        <div class="form-text">例如: weather.service 或 8位数字ID</div>
                    </div>
                    <div class="mb-3">
                        <label for="message_type" class="form-label">消息类型</label>
                        <select class="form-select" id="message_type" name="message_type">
                            <option value="NORMAL">NORMAL (普通消息)</option>
                            <option value="VOICE">VOICE (含声纹的语音导出)</option>
                            <option value="SYSTEM">SYSTEM (系统/服务号消息)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">内容</label>
                        <textarea class="form-control" id="content" name="content" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">发送</button>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">说明</div>
            <div class="card-body small text-muted">
                <p>此页面使用 <code>MessageService.send_message</code> 接口，模拟客户端行为。</p>
                <p>你可以给自己发送消息，也可以给服务号发送指令（如“天气”、“运势”）来测试自动回复。</p>
            </div>
        </div>
    </div>

    <!-- 消息列表 -->
    <div class="col-md-8">
        <ul class="nav nav-tabs mb-3" id="msgTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="inbox-tab" data-bs-toggle="tab" data-bs-target="#inbox" type="button">收件箱</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="outbox-tab" data-bs-toggle="tab" data-bs-target="#outbox" type="button">发件箱</button>
            </li>
        </ul>
        
        <div class="tab-content" id="msgTabsContent">
            <!-- 收件箱 -->
            <div class="tab-pane fade show active" id="inbox">
                <div class="list-group">
                    {% for msg in received_messages %}
                    <div class="list-group-item list-group-item-action flex-column align-items-start">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1 text-primary">{{ msg.sender_bipupu_id }}</h5>
                            <small class="text-muted">{{ msg.created_at.strftime('%m-%d %H:%M') }}</small>
                        </div>
                        <p class="mb-1">{{ msg.content }}</p>
                        <small class="text-muted">Type: {{ msg.message_type }}</small>
                    </div>
                    {% else %}
                    <div class="text-center p-4 text-muted">暂无收到消息</div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- 发件箱 -->
            <div class="tab-pane fade" id="outbox">
                <div class="list-group">
                    {% for msg in sent_messages %}
                    <div class="list-group-item list-group-item-action flex-column align-items-start">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">To: {{ msg.receiver_bipupu_id }}</h5>
                            <small class="text-muted">{{ msg.created_at.strftime('%m-%d %H:%M') }}</small>
                        </div>
                        <p class="mb-1">{{ msg.content }}</p>
                        <small class="text-muted">Type: {{ msg.message_type }}</small>
                    </div>
                    {% else %}
                    <div class="text-center p-4 text-muted">暂无发送消息</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
